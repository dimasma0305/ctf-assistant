<% 
const layoutData = {
    title: 'Event Form',
    user: isAdmin ? 'admin' : 'user',
    currentPage: isAdmin ? 'admin' : 'events',
    pageHeader: event._id ? 'Edit Event' : 'Create Event',
    headerActions: `
        <% if (isAdmin) { %>
            <a href="/admin/events" class="btn btn-secondary btn-custom">
                <i class="bi bi-arrow-left me-2"></i>Back to Events
            </a>
        <% } %>
        <button type="submit" form="eventForm" class="btn btn-primary btn-custom">
            <i class="bi bi-save me-2"></i>Save Event
        </button>
    `,
    cssFiles: ['event-form'],
    jsFiles: ['event-form']
};
%>

<%- include('../../layout', { 
    ...layoutData, 
    body: `
        <div class="row">
            <div class="col-12">
                <form id="eventForm" action="<%= isAdmin ? '/admin/event/' : '/event/' %><%= event._id || '' %>" method="post" class="needs-validation" novalidate>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>Event Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="organizer" class="form-label">
                                        <i class="bi bi-building me-2"></i>Organizer
                                    </label>
                                    <input type="text" class="form-control" id="organizer" name="organizer" 
                                           placeholder="Enter organizer name" value="<%= event.organizer || '' %>" required>
                                    <div class="invalid-feedback">
                                        Please provide an organizer name.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="title" class="form-label">
                                        <i class="bi bi-flag me-2"></i>Event Title
                                    </label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           placeholder="Enter event title" value="<%= event.title || '' %>" required>
                                    <div class="invalid-feedback">
                                        Please provide an event title.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    <i class="bi bi-text-paragraph me-2"></i>Description
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="4" 
                                          placeholder="Enter event description"><%= event.description || '' %></textarea>
                                <div class="form-text">
                                    Must be 800 characters or fewer. <span id="charCount" class="text-info">0</span>/800
                                </div>
                            </div>
                        </div>
                    </div>
                        
                        <!-- URL Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-link me-2"></i>Event Links
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <%- include('../../partials/form-input', {
                                            id: 'url',
                                            label: 'Event URL',
                                            type: 'url',
                                            placeholder: 'https://example.com/ctf',
                                            value: event.url || '',
                                            helpText: 'Main event website or platform URL'
                                        }) %>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <%- include('../../partials/form-input', {
                                            id: 'logo',
                                            label: 'Logo URL',
                                            type: 'url',
                                            placeholder: 'https://example.com/logo.png',
                                            value: event.logo || '',
                                            helpText: 'URL to event logo image'
                                        }) %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Format & Restrictions Section -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-gear me-2"></i>Event Configuration
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="bi bi-layout-three-columns me-2"></i>Format
                                        </label>
                                        <div class="mb-3">
                                            <% eventSchema.format.enum.forEach(format => { %>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="format<%= format %>" name="format" value="<%= format %>" <%= event.format && event.format.includes(format) ? 'checked' : '' %>>
                                                    <label class="form-check-label" for="format<%= format %>">
                                                        <%= format %>
                                                    </label>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label">
                                            <i class="bi bi-shield me-2"></i>Restrictions
                                        </label>
                                        <div class="mb-3">
                                            <% eventSchema.restrictions.enum.forEach(restriction => { %>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="restriction<%= restriction %>" name="restrictions" value="<%= restriction %>" <%= event.restrictions && event.restrictions.includes(restriction) ? 'checked' : '' %>>
                                                    <label class="form-check-label" for="restriction<%= restriction %>">
                                                        <%= restriction %>
                                                    </label>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timelines Section -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-range me-2"></i>Event Timeline
                                </h5>
                                <button type="button" class="btn btn-success btn-sm" id="addTimeline">
                                    <i class="bi bi-plus-circle me-1"></i>Add Timeline
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Timezone</th>
                                                <th>Start Time</th>
                                                <th>End Time</th>
                                                <th>Location</th>
                                                <th width="80">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="timelineContainer">
                                            <% if (event.timelines && event.timelines.length) { %>
                                                <% event.timelines.forEach((timeline, index) => { %>
                                                    <tr class="timeline-entry">
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm" name="timelineName[]" placeholder="Main Event" value="<%= timeline.name %>">
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm timezone-select" name="timezone[]">
                                                                <option value="UTC" <%= timeline.timezone === 'UTC' ? 'selected' : '' %>>UTC</option>
                                                                <option value="WIB" <%= timeline.timezone === 'WIB' ? 'selected' : '' %>>WIB</option>
                                                                <option value="WITA" <%= timeline.timezone === 'WITA' ? 'selected' : '' %>>WITA</option>
                                                                <option value="WIT" <%= timeline.timezone === 'WIT' ? 'selected' : '' %>>WIT</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <input type="datetime-local" class="form-control form-control-sm datetime-input" name="timelineStart[]" value="<%= timeline.startTime ? new Date(timeline.startTime).toISOString().slice(0, 16) : '' %>">
                                                        </td>
                                                        <td>
                                                            <input type="datetime-local" class="form-control form-control-sm datetime-input" name="timelineEnd[]" value="<%= timeline.endTime ? new Date(timeline.endTime).toISOString().slice(0, 16) : '' %>">
                                                        </td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm" name="location[]" placeholder="Online" value="<%= timeline.location || 'Online' %>">
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-danger btn-sm remove-timeline">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                <% }) %>
                                            <% } else { %>
                                                <tr class="timeline-entry">
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm" name="timelineName[]" placeholder="Main Event" value="Main Event">
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm timezone-select" name="timezone[]">
                                                            <option value="UTC" selected>UTC</option>
                                                            <option value="WIB">WIB</option>
                                                            <option value="WITA">WITA</option>
                                                            <option value="WIT">WIT</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="datetime-local" class="form-control form-control-sm datetime-input" name="timelineStart[]">
                                                    </td>
                                                    <td>
                                                        <input type="datetime-local" class="form-control form-control-sm datetime-input" name="timelineEnd[]">
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm" name="location[]" placeholder="Online" value="Online">
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm remove-timeline">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    `
}) %>
