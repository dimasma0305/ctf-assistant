<% 
const layoutData = {
    title: 'Event Form',
    user: isAdmin ? 'admin' : 'user',
    currentPage: isAdmin ? 'admin' : 'events',
    pageHeader: event._id ? 'Edit Event' : 'Create Event',
    headerActions: `
        <% if (isAdmin) { %>
            <a href="/admin/events" class="btn btn-secondary btn-custom">
                <i class="bi bi-arrow-left me-2"></i>Back to Events
            </a>
        <% } %>
        <button type="submit" form="eventForm" class="btn btn-primary btn-custom">
            <i class="bi bi-save me-2"></i>Save Event
        </button>
    `,
    extraCSS: `
        <style>
            .table-container {
                width: 100%;
                background-color: var(--card-color);
                border-radius: 8px;
                padding: 1rem;
            }
            .timeline-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }
            .timeline-table td {
                border: 1px solid var(--border-color);
                padding: 12px;
                text-align: center;
                vertical-align: middle;
                background-color: var(--surface-color);
            }
            .timeline-table th {
                background-color: var(--primary-color);
                color: black;
                font-weight: 600;
                padding: 12px;
                text-align: center;
                border: 1px solid var(--border-color);
            }
            .checkbox-container {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
            }
            .form-check-input {
                width: 20px;
                height: 20px;
            }
            .timeline-section {
                background-color: var(--card-color);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
        </style>
    `,
    extraJS: ``
};
%>

<%- include('layout', { 
    ...layoutData, 
    body: `
        <div class="row">
            <div class="col-12">
                <form id="eventForm" action="<%= isAdmin ? '/admin/event/' : '/event/' %><%= event._id || '' %>" method="post" class="needs-validation" novalidate>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle me-2"></i>Event Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="organizer" class="form-label">
                                        <i class="bi bi-building me-2"></i>Organizer
                                    </label>
                                    <input type="text" class="form-control" id="organizer" name="organizer" 
                                           placeholder="Enter organizer name" value="<%= event.organizer || '' %>" required>
                                    <div class="invalid-feedback">
                                        Please provide an organizer name.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="title" class="form-label">
                                        <i class="bi bi-flag me-2"></i>Event Title
                                    </label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           placeholder="Enter event title" value="<%= event.title || '' %>" required>
                                    <div class="invalid-feedback">
                                        Please provide an event title.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">
                                    <i class="bi bi-text-paragraph me-2"></i>Description
                                </label>
                                <textarea class="form-control" id="description" name="description" rows="4" 
                                          placeholder="Enter event description"><%= event.description || '' %></textarea>
                                <div class="form-text">
                                    Must be 800 characters or fewer. <span id="charCount" class="text-info">0</span>/800
                                </div>
                            </div>
                        </div>
                    </div>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" name="title" placeholder="Enter title" value="<%= event.title || '' %>">
            </div>
            <div class="form-group">
                <label for="url">URL</label>
                <input type="url" class="form-control" id="url" name="url" placeholder="Enter URL" value="<%= event.url || '' %>">
            </div>
            <div class="form-group">
                <label for="restrictions">Restrictions</label>
                <div>
                    <% eventSchema.restrictions.enum.forEach(restriction => { %>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="restriction<%= restriction %>" name="restrictions" value="<%= restriction %>" <%= event.restrictions && event.restrictions.includes(restriction) ? 'checked' : '' %>>
                            <label class="form-check-label" for="restriction<%= restriction %>"><%= restriction %></label>
                        </div>
                    <% }) %>
                </div>
            </div>
            <div class="form-group">
                <label for="format">Format</label>
                <div>
                    <% eventSchema.format.enum.forEach(format => { %>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="format<%= format %>" name="format" value="<%= format %>" <%= event.format && event.format.includes(format) ? 'checked' : '' %>>
                            <label class="form-check-label" for="format<%= format %>"><%= format %></label>
                        </div>
                    <% }) %>
                </div>
            </div>
            <div class="form-group">
                <label for="logo">Logo URL</label>
                <input type="url" class="form-control" id="logo" name="logo" placeholder="Enter logo URL" value="<%= event.logo || '' %>">
            </div>
            <div class="form-group">
                <label for="timelines">Timelines</label>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Timezone</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Location</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="timelineContainer">
                        <% if (event.timelines && event.timelines.length) { %>
                            <% event.timelines.forEach((timeline, index) => { %>
                                <tr class="timeline-entry">
                                    <td>
                                        <input type="text" class="form-control" name="timelineName[]" placeholder="Enter timeline name" value="<%= timeline.name %>">
                                    </td>
                                    <td>
                                        <select class="form-control timezone-select" name="timezone[]">
                                            <option value="WIB" <%= timeline.timezone === 'WIB' ? 'selected' : '' %>>WIB</option>
                                            <option value="WITA" <%= timeline.timezone === 'WITA' ? 'selected' : '' %>>WITA</option>
                                            <option value="WIT" <%= timeline.timezone === 'WIT' ? 'selected' : '' %>>WIT</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="datetime-local" class="form-control datetime-input" name="timelineStart[]" data-timezone="<%= timeline.timezone %>" value="<%= timeline.startTime ? new Date(timeline.startTime).toISOString().slice(0, 16) : '' %>">
                                    </td>
                                    <td>
                                        <input type="datetime-local" class="form-control datetime-input" name="timelineEnd[]" data-timezone="<%= timeline.timezone %>" value="<%= timeline.endTime ? new Date(timeline.endTime).toISOString().slice(0, 16) : '' %>">
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" name="location[]" value="<%= timeline.location %>">
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger remove-timeline">Remove</button>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr class="timeline-entry">
                                <td>
                                    <input type="text" class="form-control" name="timelineName[]" placeholder="Enter timeline name">
                                </td>
                                <td>
                                    <select class="form-control timezone-select" name="timezone[]">
                                        <option value="WIB">WIB</option>
                                        <option value="WITA">WITA</option>
                                        <option value="WIT">WIT</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="datetime-local" class="form-control datetime-input" name="timelineStart[]" data-timezone="WIB">
                                </td>
                                <td>
                                    <input type="datetime-local" class="form-control datetime-input" name="timelineEnd[]" data-timezone="WIB">
                                </td>
                                <td>
                                    <input type="text" class="form-control" name="location[]" value="Online">
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger remove-timeline">Remove</button>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
                <button type="button" class="btn btn-primary mt-3" id="addTimeline">Add Timeline</button>
            </div>
            <button type="submit" class="btn btn-success">Submit</button>
        </form>
    </div>

    <script src="https://unpkg.com/jquery@latest"></script>
    <script src="https://unpkg.com/@popperjs/core@latest"></script>
    <script src="https://unpkg.com/bootstrap@4.5.2/dist/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#addTimeline').click(function () {
                let timelineEntry = `
                    <tr class="timeline-entry">
                        <td>
                            <input type="text" class="form-control" name="timelineName[]" placeholder="Enter timeline name">
                        </td>
                        <td>
                            <select class="form-control timezone-select" name="timezone[]">
                                <option value="WIB">WIB</option>
                                <option value="WITA">WITA</option>
                                <option value="WIT">WIT</option>
                            </select>
                        </td>
                        <td>
                            <input type="datetime-local" class="form-control datetime-input" name="timelineStart[]" data-timezone="WIB">
                        </td>
                        <td>
                            <input type="datetime-local" class="form-control datetime-input" name="timelineEnd[]" data-timezone="WIB">
                        </td>
                        <td>
                            <input type="text" class="form-control" name="location[]" value="Online">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger remove-timeline">Remove</button>
                        </td>
                    </tr>`;
                $('#timelineContainer').append(timelineEntry);
            });

            $(document).on('click', '.remove-timeline', function () {
                $(this).closest('.timeline-entry').remove();
            });

            $('#description').on('input', function () {
                const charCount = $(this).val().length;
                $('#charCount').text(charCount);
                if (charCount > 800) {
                    $('#descriptionHelp').addClass('text-danger');
                } else {
                    $('#descriptionHelp').removeClass('text-danger');
                }
            });

            $('#eventForm').submit(function (event) {
                const description = $('#description').val();
                if (description.length > 800) {
                    event.preventDefault();
                    alert('Description must be 800 characters or fewer.');
                }
            });

            const initialCharCount = $('#description').val().length;
            $('#charCount').text(initialCharCount);
        });
    </script>
</body>

</html>
